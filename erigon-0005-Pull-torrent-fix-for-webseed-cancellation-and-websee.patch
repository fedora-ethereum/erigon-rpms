From: Matt Joiner <anacrolix@gmail.com>
Date: Fri, 29 Aug 2025 17:26:09 +1000
Subject: [PATCH] Pull torrent fix for webseed cancellation and
 webseedUniqueRequestKey panic (#16879)

Should address #16790, which occurs due to webseed requests changing
their "slice index" right as they finish up on the boundary of the next
slice.

Also includes the "webseed request shortening" which without was causing
CloudFlare to aggressively rate limit webseeds.

Flushing of completed pieces is moved to flushing of completed files for
non-persistent piece completion such as Erigon is using.

Logging of bad response content-lengths is improved, which helps
diagnose bad snapshots on webseeds.

diff --git a/erigon-db/go.mod b/erigon-db/go.mod
index 5e5de6032d..305a4f52cf 100644
--- a/erigon-db/go.mod
+++ b/erigon-db/go.mod
@@ -20,7 +20,7 @@ require (
 	github.com/anacrolix/go-libutp v1.3.2
 	github.com/anacrolix/log v0.17.0
 	github.com/anacrolix/missinggo/v2 v2.10.0
-	github.com/anacrolix/torrent v1.59.2-0.20250821042548-a1365a81964a
+	github.com/anacrolix/torrent v1.59.2-0.20250828104414-ef5d822b7ffd
 	github.com/c2h5oh/datasize v0.0.0-20231215233829-aa82cc1e6500
 	github.com/go-quicktest/qt v1.101.0
 	github.com/hashicorp/go-retryablehttp v0.7.8
diff --git a/erigon-db/go.sum b/erigon-db/go.sum
index 2226a1fa8a..d18b7252e9 100644
--- a/erigon-db/go.sum
+++ b/erigon-db/go.sum
@@ -81,8 +81,8 @@ github.com/anacrolix/sync v0.5.4/go.mod h1:21cUWerw9eiu/3T3kyoChu37AVO+YFue1/H15
 github.com/anacrolix/tagflag v0.0.0-20180109131632-2146c8d41bf0/go.mod h1:1m2U/K6ZT+JZG0+bdMK6qauP49QT4wE5pmhJXOKKCHw=
 github.com/anacrolix/tagflag v1.0.0/go.mod h1:1m2U/K6ZT+JZG0+bdMK6qauP49QT4wE5pmhJXOKKCHw=
 github.com/anacrolix/tagflag v1.1.0/go.mod h1:Scxs9CV10NQatSmbyjqmqmeQNwGzlNe0CMUMIxqHIG8=
-github.com/anacrolix/torrent v1.59.2-0.20250821042548-a1365a81964a h1:PITeE0LFKPGta4Pbhh2IsVsMUJ1K5DLhmjEHCu7k+jc=
-github.com/anacrolix/torrent v1.59.2-0.20250821042548-a1365a81964a/go.mod h1:6hGL5nOAk4j0zrPqyZ7GKYIkRPgehXFE9N8N6rAatQI=
+github.com/anacrolix/torrent v1.59.2-0.20250828104414-ef5d822b7ffd h1:IUhF4T7D56pPwiIZzlPJvJeAUiRNrCbIpoS/s16LCrQ=
+github.com/anacrolix/torrent v1.59.2-0.20250828104414-ef5d822b7ffd/go.mod h1:6hGL5nOAk4j0zrPqyZ7GKYIkRPgehXFE9N8N6rAatQI=
 github.com/anacrolix/upnp v0.1.4 h1:+2t2KA6QOhm/49zeNyeVwDu1ZYS9dB9wfxyVvh/wk7U=
 github.com/anacrolix/upnp v0.1.4/go.mod h1:Qyhbqo69gwNWvEk1xNTXsS5j7hMHef9hdr984+9fIic=
 github.com/anacrolix/utp v0.1.0 h1:FOpQOmIwYsnENnz7tAGohA+r6iXpRjrq8ssKSre2Cp4=
diff --git a/erigon-lib/go.mod b/erigon-lib/go.mod
index 2bfc942c2a..f1c4ec6e2a 100644
--- a/erigon-lib/go.mod
+++ b/erigon-lib/go.mod
@@ -18,7 +18,7 @@ require (
 	github.com/FastFilter/xorfilter v0.2.1
 	github.com/RoaringBitmap/roaring/v2 v2.9.0
 	github.com/anacrolix/missinggo/v2 v2.10.0
-	github.com/anacrolix/torrent v1.58.2-0.20250812132736-231b02a64d10
+	github.com/anacrolix/torrent v1.59.2-0.20250828104414-ef5d822b7ffd
 	github.com/benesch/cgosymbolizer v0.0.0-20190515212042-bec6fe6e597b
 	github.com/c2h5oh/datasize v0.0.0-20231215233829-aa82cc1e6500
 	github.com/consensys/gnark-crypto v0.17.0
@@ -80,7 +80,7 @@ require (
 )
 
 require (
-	github.com/anacrolix/generics v0.0.4-0.20250708073025-68393b391647 // indirect
+	github.com/anacrolix/generics v0.1.0 // indirect
 	github.com/anacrolix/missinggo v1.3.0 // indirect
 	github.com/beorn7/perks v1.0.1 // indirect
 	github.com/bits-and-blooms/bitset v1.20.0 // indirect
diff --git a/erigon-lib/go.sum b/erigon-lib/go.sum
index 1715242a98..71c9c71932 100644
--- a/erigon-lib/go.sum
+++ b/erigon-lib/go.sum
@@ -18,13 +18,13 @@ github.com/alecthomas/template v0.0.0-20160405071501-a0175ee3bccc/go.mod h1:LOuy
 github.com/alecthomas/template v0.0.0-20190718012654-fb15b899a751/go.mod h1:LOuyumcjzFXgccqObfd/Ljyb9UuFJ6TxHnclSeseNhc=
 github.com/alecthomas/units v0.0.0-20151022065526-2efee857e7cf/go.mod h1:ybxpYRFXyAe+OPACYpWeL0wqObRcbAqCMya13uyzqw0=
 github.com/alecthomas/units v0.0.0-20190717042225-c3de453c63f4/go.mod h1:ybxpYRFXyAe+OPACYpWeL0wqObRcbAqCMya13uyzqw0=
-github.com/anacrolix/dht/v2 v2.22.2-0.20250623060212-d7b7d8a52b01 h1:guAizoaLxE4K4nHysq5GuLJAZoHs1FJI4Dr0kKqFdz0=
-github.com/anacrolix/dht/v2 v2.22.2-0.20250623060212-d7b7d8a52b01/go.mod h1:seXRz6HLw8zEnxlysf9ye2eQbrKUmch6PyOHpe/Nb/U=
+github.com/anacrolix/dht/v2 v2.23.0 h1:EuD17ykTTEkAMPLjBsS5QjGOwuBgLTdQhds6zPAjeVY=
+github.com/anacrolix/dht/v2 v2.23.0/go.mod h1:seXRz6HLw8zEnxlysf9ye2eQbrKUmch6PyOHpe/Nb/U=
 github.com/anacrolix/envpprof v0.0.0-20180404065416-323002cec2fa/go.mod h1:KgHhUaQMc8cC0+cEflSgCFNFbKwi5h54gqtVn8yhP7c=
 github.com/anacrolix/envpprof v1.0.0/go.mod h1:KgHhUaQMc8cC0+cEflSgCFNFbKwi5h54gqtVn8yhP7c=
 github.com/anacrolix/envpprof v1.1.0/go.mod h1:My7T5oSqVfEn4MD4Meczkw/f5lSIndGAKu/0SM/rkf4=
-github.com/anacrolix/generics v0.0.4-0.20250708073025-68393b391647 h1:dDTY2j+pjY0EnF0TIuAxees1FeFpnFVE2dr7BxfWe24=
-github.com/anacrolix/generics v0.0.4-0.20250708073025-68393b391647/go.mod h1:MN3ve08Z3zSV/rTuX/ouI4lNdlfTxgdafQJiLzyNRB8=
+github.com/anacrolix/generics v0.1.0 h1:r6OgogjCdml3K5A8ixUG0X9DM4jrQiMfIkZiBOGvIfg=
+github.com/anacrolix/generics v0.1.0/go.mod h1:MN3ve08Z3zSV/rTuX/ouI4lNdlfTxgdafQJiLzyNRB8=
 github.com/anacrolix/log v0.3.0/go.mod h1:lWvLTqzAnCWPJA08T2HCstZi0L1y2Wyvm3FJgwU9jwU=
 github.com/anacrolix/log v0.6.0/go.mod h1:lWvLTqzAnCWPJA08T2HCstZi0L1y2Wyvm3FJgwU9jwU=
 github.com/anacrolix/missinggo v1.1.0/go.mod h1:MBJu3Sk/k3ZfGYcS7z18gwfu72Ey/xopPFJJbTi5yIo=
@@ -43,8 +43,8 @@ github.com/anacrolix/stm v0.2.0/go.mod h1:zoVQRvSiGjGoTmbM0vSLIiaKjWtNPeTvXUSdJQ
 github.com/anacrolix/tagflag v0.0.0-20180109131632-2146c8d41bf0/go.mod h1:1m2U/K6ZT+JZG0+bdMK6qauP49QT4wE5pmhJXOKKCHw=
 github.com/anacrolix/tagflag v1.0.0/go.mod h1:1m2U/K6ZT+JZG0+bdMK6qauP49QT4wE5pmhJXOKKCHw=
 github.com/anacrolix/tagflag v1.1.0/go.mod h1:Scxs9CV10NQatSmbyjqmqmeQNwGzlNe0CMUMIxqHIG8=
-github.com/anacrolix/torrent v1.58.2-0.20250812132736-231b02a64d10 h1:eY67v1U6EPpU5PGam1CLRcLChFpLi0OJUxv3AXNjmEU=
-github.com/anacrolix/torrent v1.58.2-0.20250812132736-231b02a64d10/go.mod h1:0r+Z8uhOf5vRYL8a0hnrN4lLehhPmDFlwfsQeEOUFss=
+github.com/anacrolix/torrent v1.59.2-0.20250828104414-ef5d822b7ffd h1:IUhF4T7D56pPwiIZzlPJvJeAUiRNrCbIpoS/s16LCrQ=
+github.com/anacrolix/torrent v1.59.2-0.20250828104414-ef5d822b7ffd/go.mod h1:6hGL5nOAk4j0zrPqyZ7GKYIkRPgehXFE9N8N6rAatQI=
 github.com/apache/thrift v0.12.0/go.mod h1:cp2SuWMxlEZw2r+iP2GNCdIi4C1qmUzdZFSVb+bacwQ=
 github.com/benbjohnson/clock v1.1.0/go.mod h1:J11/hYXuz8f4ySSvYwY0FKfm+ezbsZBKZxNJlLklBHA=
 github.com/benbjohnson/immutable v0.2.0/go.mod h1:uc6OHo6PN2++n98KHLxW8ef4W42ylHiQSENghE1ezxI=
diff --git a/go.mod b/go.mod
index 6d5dafa4b9..d51826e510 100644
--- a/go.mod
+++ b/go.mod
@@ -37,7 +37,7 @@ require (
 	github.com/anacrolix/go-libutp v1.3.2 // indirect
 	github.com/anacrolix/log v0.17.0 // indirect
 	github.com/anacrolix/missinggo/v2 v2.10.0
-	github.com/anacrolix/torrent v1.59.2-0.20250821042548-a1365a81964a
+	github.com/anacrolix/torrent v1.59.2-0.20250828104414-ef5d822b7ffd
 	github.com/c2h5oh/datasize v0.0.0-20231215233829-aa82cc1e6500
 	github.com/cenkalti/backoff/v4 v4.2.1
 	github.com/consensys/gnark-crypto v0.18.0
diff --git a/go.sum b/go.sum
index 8b04220c08..04b3b4f6cc 100644
--- a/go.sum
+++ b/go.sum
@@ -141,8 +141,8 @@ github.com/anacrolix/sync v0.5.4/go.mod h1:21cUWerw9eiu/3T3kyoChu37AVO+YFue1/H15
 github.com/anacrolix/tagflag v0.0.0-20180109131632-2146c8d41bf0/go.mod h1:1m2U/K6ZT+JZG0+bdMK6qauP49QT4wE5pmhJXOKKCHw=
 github.com/anacrolix/tagflag v1.0.0/go.mod h1:1m2U/K6ZT+JZG0+bdMK6qauP49QT4wE5pmhJXOKKCHw=
 github.com/anacrolix/tagflag v1.1.0/go.mod h1:Scxs9CV10NQatSmbyjqmqmeQNwGzlNe0CMUMIxqHIG8=
-github.com/anacrolix/torrent v1.59.2-0.20250821042548-a1365a81964a h1:PITeE0LFKPGta4Pbhh2IsVsMUJ1K5DLhmjEHCu7k+jc=
-github.com/anacrolix/torrent v1.59.2-0.20250821042548-a1365a81964a/go.mod h1:6hGL5nOAk4j0zrPqyZ7GKYIkRPgehXFE9N8N6rAatQI=
+github.com/anacrolix/torrent v1.59.2-0.20250828104414-ef5d822b7ffd h1:IUhF4T7D56pPwiIZzlPJvJeAUiRNrCbIpoS/s16LCrQ=
+github.com/anacrolix/torrent v1.59.2-0.20250828104414-ef5d822b7ffd/go.mod h1:6hGL5nOAk4j0zrPqyZ7GKYIkRPgehXFE9N8N6rAatQI=
 github.com/anacrolix/upnp v0.1.4 h1:+2t2KA6QOhm/49zeNyeVwDu1ZYS9dB9wfxyVvh/wk7U=
 github.com/anacrolix/upnp v0.1.4/go.mod h1:Qyhbqo69gwNWvEk1xNTXsS5j7hMHef9hdr984+9fIic=
 github.com/anacrolix/utp v0.1.0 h1:FOpQOmIwYsnENnz7tAGohA+r6iXpRjrq8ssKSre2Cp4=
